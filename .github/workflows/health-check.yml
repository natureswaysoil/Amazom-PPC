name: Health Check and Notifications

on:
  # Triggered after the Deploy workflow completes
  workflow_run:
    workflows: ["Deploy to Google Cloud"]
    types: [completed]

  # Manual trigger with configurable inputs
  workflow_dispatch:
    inputs:
      function_url:
        description: "Cloud Function URL (overrides secrets.FUNCTION_URL)"
        required: false
        type: string
      require_auth:
        description: "Use identity token auth (true/false)"
        required: false
        default: true
        type: boolean
      region:
        description: "Region for gcloud discovery (optional)"
        required: false
        type: string
      function_name:
        description: "Function name for gcloud discovery (optional)"
        required: false
        type: string

jobs:
  health-check-and-notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    env:
      INPUT_FUNCTION_URL: ${{ inputs.function_url }}
      SECRET_FUNCTION_URL: ${{ secrets.FUNCTION_URL }}
      REQUIRE_AUTH: ${{ inputs.require_auth || secrets.HEALTH_REQUIRE_AUTH || true }}
      REGION_INPUT: ${{ inputs.region }}
      FUNCTION_NAME_INPUT: ${{ inputs.function_name }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_PASS: ${{ secrets.GMAIL_PASS }}
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine auth configuration
        id: auth_config
        shell: bash
        run: |
          python - <<'PY'
import os


def _is_truthy(value: object) -> bool:
    if isinstance(value, bool):
        return value
    if value is None:
        return False
    text = str(value).strip().lower()
    if not text or text in {"0", "false", "no", "off", "null", "none"}:
        return False
    return text in {"1", "true", "yes", "on"} or text == "require_auth"


def _combine_split_env(base_name: str) -> str | None:
    prefix_len = len(base_name)
    parts: list[tuple[int, str]] = []

    for env_name, env_value in os.environ.items():
        if not env_value or not env_name.startswith(base_name):
            continue

        suffix = env_name[prefix_len:]
        if not suffix:
            continue

        trimmed = suffix.strip("_- ")
        if not trimmed:
            continue

        upper = trimmed.upper()
        index_str: str | None = None

        if upper.startswith("PART"):
            remainder = trimmed[4:].strip("_- ")
            if remainder.isdigit():
                index_str = remainder
        elif trimmed.isdigit():
            index_str = trimmed

        if index_str is None:
            continue

        index = int(index_str)
        parts.append((index, env_value))

    if not parts:
        return None

    parts.sort(key=lambda item: item[0])
    return "".join(value for _, value in parts)


def _resolve_env_value(candidates: list[str]) -> str | None:
    for name in candidates:
        value = os.environ.get(name)
        if value and value.strip():
            return value

    for name in candidates:
        combined = _combine_split_env(name)
        if combined:
            return combined

    return None


require_auth = _is_truthy(os.environ.get("REQUIRE_AUTH"))
if not require_auth and _is_truthy(os.environ.get("HEALTH_REQUIRE_AUTH")):
    require_auth = True

workload_identity_provider = (os.environ.get("GCP_WORKLOAD_IDENTITY_PROVIDER") or "").strip()
service_account = (os.environ.get("GCP_SERVICE_ACCOUNT") or "").strip()

service_account_key = _resolve_env_value([
    "GCP_SA_KEY",
    "GCP_SERVICE_ACCOUNT_KEY",
])

if not service_account_key:
    service_account_key = _resolve_env_value(["GOOGLE_APPLICATION_CREDENTIALS"])

env_updates: list[str] = []

normalized_require_auth = "true" if require_auth else "false"
env_updates.append(f"REQUIRE_AUTH={normalized_require_auth}")

if service_account_key:
    env_updates.append(f"GCP_SA_KEY={service_account_key}")
    env_updates.append(f"GCP_SERVICE_ACCOUNT_KEY={service_account_key}")

github_env = os.environ.get("GITHUB_ENV")
if github_env and env_updates:
    with open(github_env, "a", encoding="utf-8") as env_file:
        for line in env_updates:
            env_file.write(f"{line}\n")

use_workload_identity = require_auth and bool(workload_identity_provider) and bool(service_account)
use_json_key = require_auth and not use_workload_identity and bool(service_account_key)
missing_credentials = require_auth and not use_workload_identity and not bool(service_account_key)

outputs_path = os.environ.get("GITHUB_OUTPUT")
if outputs_path:
    with open(outputs_path, "a", encoding="utf-8") as output:
        output.write(f"require_auth={normalized_require_auth}\n")
        output.write(f"use_workload_identity={'true' if use_workload_identity else 'false'}\n")
        output.write(f"use_json_key={'true' if use_json_key else 'false'}\n")
        output.write(f"missing_credentials={'true' if missing_credentials else 'false'}\n")

if service_account_key:
    print("Detected Google Cloud JSON credentials from environment variables.")
elif use_workload_identity:
    print("Configured to use Workload Identity Federation for Google Cloud auth.")
elif require_auth:
    print("Google Cloud auth is required but no credentials detected.")
else:
    print("Google Cloud auth not required for this run.")
PY

      - name: Setup gcloud (if auth required)
        if: ${{ steps.auth_config.outputs.require_auth == 'true' }}
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: '>= 471.0.0'

      - name: Auth to Google Cloud via Workload Identity
        if: ${{ steps.auth_config.outputs.use_workload_identity == 'true' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}

      - name: Auth to Google Cloud via JSON key
        if: ${{ steps.auth_config.outputs.use_json_key == 'true' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SA_KEY }}

      - name: Fail if Google Cloud auth is required but not configured
        if: ${{ steps.auth_config.outputs.missing_credentials == 'true' }}
        run: |
          echo "::error::Google Cloud auth is required but no valid credentials were provided."
          echo "Set GCP_WORKLOAD_IDENTITY_PROVIDER and GCP_SERVICE_ACCOUNT secrets for workload identity,"
          echo "or provide GCP_SA_KEY for JSON key authentication."
          exit 1
      - name: Resolve FUNCTION_URL
        id: resolve_url
        shell: bash
        run: |
          set -e
          if [ -n "$INPUT_FUNCTION_URL" ]; then
            echo "Using function URL from workflow input"
            echo "function_url=$INPUT_FUNCTION_URL" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -n "$SECRET_FUNCTION_URL" ]; then
            echo "Using function URL from repository secret"
            echo "function_url=$SECRET_FUNCTION_URL" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -n "$FUNCTION_NAME_INPUT" ] && [ -n "$REGION_INPUT" ]; then
            echo "Discovering Cloud Run URL via gcloud..."
            URL=$(gcloud functions describe "$FUNCTION_NAME_INPUT" --region="$REGION_INPUT" --gen2 --format='value(serviceConfig.uri)' || true)
            if [ -n "$URL" ]; then
              echo "function_url=$URL" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "::error::FUNCTION_URL not provided. Set inputs.function_url or secrets.FUNCTION_URL, or provide function_name+region with gcloud auth."
          exit 1

      - name: Wait for deployment to be ready
        run: |
          echo "Waiting 30 seconds for Cloud Function to be fully available..."
          sleep 30

      - name: Run Health Check
        id: health_check
        env:
          FUNCTION_URL: ${{ steps.resolve_url.outputs.function_url }}
        run: |
          echo "Running health check on Cloud Function..."
          HEALTH_URL="${FUNCTION_URL%/}?health=true"
          if [[ "${{ env.REQUIRE_AUTH }}" == "true" || "${{ env.REQUIRE_AUTH }}" == true ]]; then
            TOKEN=$(gcloud auth print-identity-token)
            RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer ${TOKEN}" "$HEALTH_URL" || echo "000")
          else
            RESPONSE=$(curl -s -w "\n%{http_code}" "$HEALTH_URL" || echo "000")
          fi
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response_body=$BODY" >> $GITHUB_OUTPUT
          if [ "$HTTP_CODE" = "200" ] && echo "$BODY" | grep -q "healthy"; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "✅ Health check passed!"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "❌ Health check failed!"
            exit 1
          fi

      - name: Send Email Notification
        if: always() && env.GMAIL_USER != '' && env.GMAIL_PASS != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USER }}
          password: ${{ secrets.GMAIL_PASS }}
          subject: "Amazon PPC Optimizer - Deployment Health Check ${{ steps.health_check.outputs.status == 'success' && '✅ PASSED' || '❌ FAILED' }}"
          to: natureswaysoil@gmail.com,james@natureswaysoil.com
          from: ${{ secrets.GMAIL_USER }}
          body: |
            Amazon PPC Optimizer Cloud Function - Health Check Report

            Repository: ${{ github.repository }}
            Run ID: ${{ github.run_id }}
            Triggered by: ${{ github.event_name }}
            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}

            Status: ${{ steps.health_check.outputs.status == 'success' && '✅ SUCCESS' || '❌ FAILED' }}
            HTTP Status Code: ${{ steps.health_check.outputs.http_code }}
            Response: ${{ steps.health_check.outputs.response_body }}
            Function URL: ${{ steps.resolve_url.outputs.function_url }}
            Health Endpoint: ${{ steps.resolve_url.outputs.function_url }}?health=true

      - name: Post to Dashboard API
        if: steps.health_check.outputs.status == 'success'
        env:
          FUNCTION_URL: ${{ steps.resolve_url.outputs.function_url }}
        run: |
          echo "Posting health check results to dashboard..."
          if [ -z "${{ secrets.DASHBOARD_API_ENDPOINT }}" ]; then
            echo "⚠️ DASHBOARD_API_ENDPOINT secret not configured (optional)."
            exit 0
          fi
          PAYLOAD=$(cat <<EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "status": "${{ steps.health_check.outputs.status }}",
            "http_code": "${{ steps.health_check.outputs.http_code }}",
            "response": ${{ toJSON(steps.health_check.outputs.response_body) }},
            "deployment": {
              "repository": "${{ github.repository }}",
              "commit": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "workflow_run_id": "${{ github.run_id }}"
            },
            "cloud_function": {
              "url": "${FUNCTION_URL}",
              "health_endpoint": "${FUNCTION_URL%/}?health=true"
            }
          }
          EOF
          )
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DASHBOARD_API_KEY }}" \
            -d "$PAYLOAD" \
            "${{ secrets.DASHBOARD_API_ENDPOINT }}" || echo "000")
          API_HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          API_BODY=$(echo "$RESPONSE" | head -n-1)
          echo "Dashboard API Response: $API_HTTP_CODE"
          echo "$API_BODY"

      - name: Summary
        if: always()
        env:
          FUNCTION_URL: ${{ steps.resolve_url.outputs.function_url }}
        run: |
          echo "## Health Check Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.health_check.outputs.status }}" = "success" ]; then
            echo "✅ **Status**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Status**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\n**HTTP Status Code**: ${{ steps.health_check.outputs.http_code }}" >> $GITHUB_STEP_SUMMARY
          echo "\n**Response**: \`${{ steps.health_check.outputs.response_body }}\`" >> $GITHUB_STEP_SUMMARY
          echo "\n**Cloud Function URL**: ${FUNCTION_URL}" >> $GITHUB_STEP_SUMMARY
          echo "\n**Dashboard**: https://amazonppcdashboard-db7ltsqjn-james-projects-5e9a58a0.vercel.app" >> $GITHUB_STEP_SUMMARY
